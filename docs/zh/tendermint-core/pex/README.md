# 对等策略与交流

这里我们概述了 PeerStore 的设计
以及 Peer Exchange Reactor (PEX) 如何使用它来确保我们连接
对好同伴和对他人八卦的同伴.

## 对等类型

某些对等点的特殊性在于它们由用户指定为“持久性”，
这意味着如果连接失败，或者我们拨号失败，我们会自动重拨它们
他们.
一些对等点可以标记为“私有”，这意味着
我们不会将它们放在同行商店中或将它们八卦给其他人.

除了私有对等点和来自它们的对等点之外的所有对等点都使用
同行商店.

我们其他同行的唯一区别在于:
入站(他们拨打我们的公共地址)或出站(我们拨打他们).

## 发现

对等发现从种子列表开始.

当我们没有足够的同伴时，我们

1.询问现有同行
2. 如果我们目前没有拨打任何人，请拨打种子

在启动时，我们也会立即拨打给定的“persistent_peers”列表，
并将尝试与他们保持持久的连接.如果
连接中断，或者我们拨号失败，我们将每隔 5s 重拨几分钟，
然后切换到指数退避计划，大约一天后
尝试，停止拨号对等体.这种行为是当 `persistent_peers_max_dial_period` 配置为零时.

但是如果 `persistent_peers_max_dial_period` 设置为大于零，则每次拨号到每个持久对等方之间的条款
在指数退避期间不会超过“persistent_peers_max_dial_period”.
因此，`dial_period` = min(`persistent_peers_max_dial_period`, `exponential_backoff_dial_period`)
不管`maxAttemptsToDial`如何，我们都会继续尝试

只要我们少于 `MaxNumOutboundPeers`，我们就会定期请求
来自我们每个人的其他同行并尝试种子.

## 聆听

Peers 监听一个可配置的 ListenAddr，他们在他们的
与其他对等方握手期间的 NodeInfo.同行最多接受
`MaxNumInboundPeers` 传入对等点.

## 地址簿

对等点通过它们的 ID(它们的 PubKey.Address())进行跟踪.
对等点第一次连接到我们时会从 PEX 添加到对等存储中，或者
当我们从其他同行那里听说他们时.

peer store 是按照bucket的集合排列的，并且区分
经过审查的(旧)和未经审查的(新)同行.它保留不同的桶组
经过审查和未经审查的同行.存储桶提供对等方选择的随机化.
对等点根据其 IP 组放入桶中.

IP 组可以是掩码 IP(例如`1.2.0.0` 或`2602:100::`)或`local`，用于
本地地址或不可路由地址的“不可路由”.那个面具
对应于`/16` 子网用于IPv4，`/32​​` 子网-用于IPv6.
每个组都有有限数量的桶，以防止来自
该组(例如，攻击者购买了一个“/16”IP 块并启动了 DoS
攻击).

[highwayhash](https://arxiv.org/abs/1612.06257) 用作散列函数
计算桶时.

将节点放入新存储桶时:

```md
hash(key + sourcegroup + int64(hash(key + group + sourcegroup)) % bucket_per_group) % num_new_buckets
```

将 peer 放入旧桶时:

```md
hash(key + group + int64(hash(key + addr)) % buckets_per_group) % num_old_buckets
```

其中`key` - 随机的24 HEX 字符串，`group` - 对等端的IP 组(例如`1.2.0.0`)，
`sourcegroup` - 发件人的 IP 组(向我们发送此地址的对等方)(例如 `174.11.0.0`)，
`addr` - 对等地址的字符串表示(例如 `174.11.10.2:26656`).

经过审查的同行只能在一个桶中.未经审查的对等点可以位于多个存储桶中，并且
对等方的每个实例都可以有不同的 IP:PORT.

如果我们试图添加一个新的对等点，但它的存储桶中没有空间，我们将
从该桶中删除最差的对等点以腾出空间.

## 审核

当第一次添加对等点时，它是未经审查的.
将 peer 标记为已审查超出了 p2p 包的范围.
对于 Tendermint，一旦 Peer 做出了足够的贡献，它就会被审查
在共识层； IE.一旦它向我们发送了有效且未知的信息
“NumBlocksForVetted”块的投票和/或块部分.
p2p 包的其他用户可以确定他们自己的条件，以便对等方标记为审查.

如果一个同行被审查但已经有太多审查的同行，
随机选择的经过审查的同行之一变得未经审查.

如果同行变得未经审查(新的同行，或之前经过审查的同行)，
从对等存储中删除随机选择的未经审查的对等节点之一.

可以使用更细粒度的对等行为跟踪
信任指标(见下文)，但最好从简单的事情开始.

## 选择要拨号的对等方

当我们需要更多对等点时，我们会从 addrbook 中随机选择一些地址
未经审查的同行的可配置偏差.当我们有时，偏差应该更低
更少的同行，并且可以随着我们获得更多而增加，确保我们的第一批同行
更值得信赖，但总是让我们有机会发现新的好东西
同行.

我们跟踪上次拨打对等方的时间以及尝试失败的次数
我们已经做了.如果进行了过多的尝试，我们会将对等点标记为坏的.

连接尝试是通过指数退避(加上抖动)进行的.因为
选择过程发生在每个 `ensurePeersPeriod`，我们可能不会结束
拨打对等方的时间比退避持续时间长得多.

如果我们在 16 次尝试后未能连接到对等点(使用指数退避)，我们
完全从对等商店中删除.但对于坚持不懈的同行，我们无限期地尝试
拨打所有持久对等点，除非 `persistent_peers_max_dial_period` 配置为零

## 选择要交换的对等点

当我们被要求提供同行时，我们按如下方式选择它们:

- 最多选择 `maxGetSelection` 对等节点
- 尝试至少选择 `minGetSelection` 对等节点 - 如果少于该值，则全部选择.
- 选择一个随机的、无偏见的“getSelectionPercent”对等点

发送选定的对等点.请注意，我们选择对等点进行无偏见的审查/未审查.

## 防止垃圾邮件

在各种情况下，我们认为对等方行为不端，并与他们断开连接.
发生这种情况时，对等点将从对等点存储中删除并列入黑名单
一些时间.我们称之为“断开连接并标记”.
请注意，可能会在 PEX 反应器本身之外检测到不良行为
(例如，在 mconnection 或另一个反应器中)，但它必须与 PEX 反应器通信
所以它可以删除和标记对等点.

在 PEX 中，如果一个对等点向我们发送了一份未经请求的对等点列表，
或者如果对等方在另一个请求之后太快地发送请求，
我们断开连接和 MarkBad.

## 信任指标

可以使用更细粒度的细节跟踪对等点的质量
比例积分微分 (PID) 控制器包含
当前、过去和变化率数据，以告知同行质量.

虽然已经实施了 PID 信任度量，但它仍待未来工作
在 PEX 中使用它.

请参阅 [trustmetric](https://github.com/tendermint/tendermint/blob/master/docs/architecture/adr-006-trust-metric.md)
和 [trustmetric useage](https://github.com/tendermint/tendermint/blob/master/docs/architecture/adr-007-trust-metric-usage.md)
有关更多详细信息，请参阅架构文档.





<!-- todo: diagrams!!! -->
