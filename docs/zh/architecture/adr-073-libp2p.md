# ADR 073:采用 LibP2P

## 变更日志

- 2021-11-02:初稿(@tychoish)

## 状态

建议的.

## 语境


作为 0.35 开发周期的一部分，Tendermint 团队完成了
ADR 61 和 62 中描述的工作的第一阶段，其中包括
反应堆和 p2p 消息的大规模重构
路由.这取代了开关和许多其他传统
不破坏协议或网络级别的组件
互操作性并留下遗留的连接/套接字处理代码.

发布后，团队重新检查了代码的状态
和设计，以及 Tendermint 的要求.笔记
可以在 [P2P 路线图
RFC][RFC].

本 ADR 取代了 ADR 60 和 61 中做出的决定，但
建立在这项工作的已完成部分的基础上.此前，该
对等管理、消息处理和更高级别的边界
业务逻辑(例如，“反应堆”)混合在一起，核心
p2p 系统的元素负责编排
更高层次的业务逻辑.重构遗留组件
更明显的是这种责任的纠缠
对整个实施产生了巨大的影响，使得
很难在当前的抽象中迭代.
保持与遗留系统的互操作性是不可行的
系统，同时还实现了我们许多更广泛的目标.

LibP2P 是点对点的彻底指定的实现
网络堆栈，专为系统而设计，例如
我们的.采用 LibP2P 作为 Tendermint 的基础将使
Tendermint 团队将更多的时间集中在其他差异化上
系统的各个方面，并使生态系统成为可能
整体利用 LibP2P 的工具和努力
平台.

## 替代方法

正如 [P2P 路线图 RFC][rfc] 中所讨论的，主要的替代方案是
继续发展 Tendermint 的本土点对点
层.虽然这会给 Tendermint 团队最大的控制权
与对等系统相比，当前的设计在其
自身的优点，以及该系统的预期维护负担
超过我们的中期容忍度.

Tendermint 可以而且应该区分自己，而不是基于
它的网络实施或对等管理工具，但提供
一致的操作体验，久经考验的共识算法，
以及符合人体工程学的用户体验.
## 决定

Tendermint 将在 0.37 开发周期中采用 libp2p，
替换定制的 Tendermint P2P 堆栈.这将删除
`Endpoint`、`Transport`、`Connection` 和 `PeerManager` 抽象
并留下反应器，`p2p.Router` 和 `p2p.Channel`
抽象.

LibP2P 可能不需要专用的对等交换 (PEX)
反应器，这也将避免需要一个专门的
种子模式.如果是这种情况，那么所有这些功能都会
被移除.

如果结果(根据协议实验室的建议)它使
维护单独的 pubsub 或 gossipsub 主题的意义
每个消息类型，那么`Router` 抽象也可以
被完全纳入.

## 详细设计

### 实施变更

更高级别之间 P2P 实现中的接缝
构造(反应器)，路由层(`Router`)和较低的
级别连接和对等管理代码使此操作
实施起来比较简单.关键
这种设计的目标是尽量减少对反应堆的影响
(可能完全，)并完全删除较低级别
组件(例如，`Transport`、`Connection` 和 `PeerManager`)使用
由`Router`层提供的分离.目前的状态
代码使这些变化相对外科手术，并且仅限于一个小的
方法数:

- `p2p.Router.OpenChannel` 仍然会返回一个 `Channel` 结构
  它将继续作为反应堆和反应堆之间的管道
  `路由器`.实现将不再需要队列
  实现，而是启动 goroutines
  负责将消息从通道路由到 libp2p
  基本原理，替换当前的`p2p.Router.routeChannel`.

- 当前的`p2p.Router.dialPeers`和`p2p.Router.acceptPeers`，
  负责建立出站和入站连接，
  分别.这些方法将被删除，以及
  `p2p.Router.openConnection`，libp2p 连接管理器将
  负责维护网络连接.

- `p2p.Channel` 界面将更改以替换 Go
  具有用于发送消息的更多功能接口的通道.
  此对象上的新方法将采用上下文来支持安全
  取消，并返回错误，并且会阻塞而不是
  异步运行. “出”通道，通过它
  反应器向 Peers 发送消息，将被替换为“发送”
  方法，并且错误通道将被一个 `Error` 替换
  方法.

- 反应堆将被传递一个接口，允许他们
  从 libp2p 访问对等信息.这将取代
  `p2p.PeerUpdates` 订阅.

- 在应用程序级别添加某种心跳消息
  (e.g. with a reactor,) 可能连接到 libp2p 的 DHT
  反应堆用于服务发现、消息定位或其他
  特征.

- 用 [Noise](http://www.noiseprotocol.org/noise.html) 替换现有的/传统的握手协议.

该项目最初将使用基于 TCP 的传输协议
libp2p. QUIC 也可作为我们稍后实施的选项.
我们不会在初始版本中支持混合网络，但会
如果确实有需要，请稍后重新考虑这种可能性.

### 升级和兼容性

因为路由器和所有当前的 P2P 库都是“内部的”
包而不是公共 API 的一部分，唯一对公共的更改
Tendermint 的 API 表面积将是不同的配置
文件选项，用相关选项替换当前的 P2P 选项
到 libp2p.

但是，将无法运行具有两个网络的网络
堆栈一次激活，因此升级到 Tendermint 版本
需要在网络的所有节点之间进行协调.这是
与围绕 Tendermint 移动升级的预期一致
向前推进，并将有助于管理项目的复杂性和
实施时间表.

## 开放问题

- 协议实验室在 libp2p 的实现中的作用是什么？
  Tendermint，无论是在最初的实施期间还是在持续的
  之后的依据？

- 是否应该将给定节点的所有 P2P 流量推送到单个主题，
  以便主题映射到特定的 ChainID，或者应该
  每个反应器(或消息类型)都有自己的主题？多少
  libp2p 网络可以支持主题吗？是否有验证的测试
  能力？

- Tendermint 目前提供了一个非常粗略的类似 QoS 的功能
  使用基于消息类型的优先级.
  这在直觉上/理论上确保了证据和共识
  消息不会被块同步/状态同步消息饿死.它是
  不清楚我们是否可以或应该尝试用 libp2p 复制它.

- libp2p 提供什么样的 QoS 功能以及什么样的
  libp2p 是否提供有关其 QoS 功能的指标？

- 是否可以存储额外的(可能是任意的)
  信息作为节点之间心跳的一部分进入 DHT，
  例如最新的高度，然后在
  反应堆. DHT多久更新一次？

- 让反应堆继续消耗入境是否有意义
  来自频道(`In`)的消息或者是否有另一个接口或
  我们应该考虑的模式？

- 我们应该尽可能避免暴露 Go 通道，并且可能
某种替代迭代器可能对处理有意义
反应堆内的消息.

- 跟踪的安全性和协议含义是什么
  来自对等心跳的信息并将其暴露给反应堆？

- Tendermint 可以提供多少(或多少)配置
  libp2p，尤其是在第一个版本中？

  - 一般来说，我们不应该支持 libp2p 的 byo-functionity
Tendermint 内的组件，并减少配置面
区域，尽可能.

- 提供请求/响应语义的最佳方法是什么？
  libp2p之上的反应堆？是否可以添加
  未来版本中的请求/响应语义或是否存在
  作为初始阶段的一部分需要完成的预期工作
  发布？

## 结果

### 积极的

- 通过以下方式减轻 Tendermint 核心团队的维护负担
  删除大量已被证明是的遗留代码
  很难安全地修改.

- 免去维护和开发整体的责任
  对等管理系统 (p2p) 和堆栈.

- 为用户提供更稳定的对等网络系统，
  Tendermint 可以提升运营商体验和网络稳定性.

### 消极的

- 通过遵循库实现对等管理和
  网络，Tendermint 失去了一些创新的灵活性
  对等和网络级别.然而，Tendermint 应该在创新
  主要在共识层，libp2p 不排除
  在对等层进行优化或开发.

- Libp2p 是一个很大的依赖项，Tendermint 将成为依赖项
  基于协议实验室的发布周期和错误优先级
  修复.如果这证明很麻烦，则可以维护供应商
  根据需要分叉相关组件.

### 中性的

- 不适用

## 参考

- [ADR 61:P2P 重构范围][adr61]
- [ADR 62:P2P 架构][adr62]
- [P2P 路线图 RFC][rfc]

[adr61]:./adr-061-p2p-refactor-scope.md
[adr62]:./adr-062-p2p-architecture.md
[rfc]:../rfc/rfc-000-p2p.rst
