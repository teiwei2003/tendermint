# ADR 66:端到端测试

## 变更日志

- 2020 年 9 月 7 日:初稿(@erikgrinaker)
- 2020-09-08:小改进(@erikgrinaker)
- 2021-04-12:从 RFC 001 (@tessr) 重命名

##作者

- 埃里克·格里纳克 (@erikgrinaker)

## 语境

“test/”下的当前端到端测试集非常有限，主要集中在标准配置中的 P2P 测试。他们不测试各种配置(例如快速同步反应器版本、状态同步、块修剪、创世 vs InitChain 设置)，也不测试各种网络拓扑(例如哨兵节点架构)。这会导致测试覆盖率低下，从而导致一些严重的错误被忽视。

我们需要一个端到端的测试套件，它可以运行配置选项、创世设置、网络拓扑、ABCI 交互和故障场景的大量组合，并检查网络是否仍然有效。本 ADR 概述了此类系统的基本要求和设计。

此 ADR 不会涵盖全面的混沌测试，只会涵盖一些简单的场景(例如，突然的进程终止和网络分区)。应实施核心共识算法的混沌测试，例如通过 Jepsen 测试或类似框架，或者稍后添加到这些端到端测试中。同样，恶意或对抗性行为超出了第一次实施的范围，但可能会在以后添加。

## 提议

### 功能覆盖

下面列出了我们要测试的功能:

#### 环境

- **拓扑:** 单节点，4 个节点(种子和持久)，哨兵架构，NAT (UPnP)
- **网络:** IPv4、IPv6
- **ABCI 连接:** UNIX 套接字、TCP、gRPC
- **PrivVal:** 文件、UNIX 套接字、TCP

#### 节点/应用程序配置

- **数据库:** goleveldb、cleveldb、boltdb、rocksdb、badgerdb
- **快速同步:**禁用，v0，v2
- **状态同步:** 禁用，启用
- **块修剪:** 无，保持 20，保持 1，保持随机
- **角色:**验证者，全节点
- **应用程序持久性:** 启用、禁用
- **节点模式:** 验证器、完整、光照、种子

#### 基因

- **验证器:** 无(InitChain)，给定
- **初始高度:** 1, 1000
- **应用程序状态:** 无，给定

#### 行为

- **恢复:**停止/启动、电源循环、验证器中断、网络分区、总网络丢失
- **验证器:** 添加、删除、更改电源
- **Evidence:** 注入 DuplicateVoteEvidence 和 LightClientAttackEvidence

### 功能组合

对上述功能的所有组合运行单独的测试是不可行的，因为它们有数百万个。但是，功能可以分为三大类:

- **全局:** 影响整个网络，每个组合都需要一个单独的测试网(例如拓扑、网络协议、创世设置)

- **Local:** 影响单个节点，并且可以在测试网络中的每个节点变化(例如 ABCI/privval 连接、数据库后端、块修剪)

- **Temporal:** 可以在同一个测试网络中依次运行(例如恢复和验证器更改)

因此，我们可以为全局选项的所有组合(大约 100 个)运行单独的测试网。在每个测试网中，我们运行具有针对广泛覆盖优化的随机生成的节点配置的节点(即，如果一个节点正在使用 GoLevelDB，那么如果可能，其他节点都不应该使用它)。在每个测试网中，我们依次随机选择节点来停止/启动、重启、添加/删除、断开连接等。

所有设置都应在测试网配置(或生成它的种子)中指定，以便可以从 CI 检索并在本地调试。

必须构建一个可以展示必要行为的自定义 ABCI 应用程序(例如，进行验证器更改、修剪块、启用/禁用持久性等)。

### 测试阶段

给定测试配置，测试运行器具有以下阶段:

- **Setup:** 配置 Docker 容器和网络，但不启动它们。

- **初始化:** 启动 Docker 容器，执行快速同步/状态同步。适应不同的起始高度。

- **扰动:** 添加/删除验证器、重新启动节点、扰动网络等 - 在每个操作之间检查活性和准备情况。

- **测试:** 针对所有网络节点独立运行 RPC 测试，确保数据符合预期并保持不变。

### 测试

一般的方法是让网络通过一系列操作(参见上面的阶段)，在每次操作后检查基本的活跃度和准备情况，然后在网络稳定后针对网络中的每个节点运行 RPC 测试套件。

测试套件将对单个节点的 RPC 服务进行黑盒测试。我们将测试整个网络的行为，例如一个快速同步的节点正确地赶上链头并通过 RPC 提供基本的块数据。因此测试不会发送例如P2P 消息或检查节点数据库，因为这些被视为内部实现细节 - 如果网络行为正确，则内部组件可能正常运行。综合组件测试(例如每个 RPC 方法参数)应该通过单元/集成测试来完成。

测试必须考虑节点配置(例如，一些节点可能被修剪，其他节点可能不是验证者)，并且应该以某种方式提供对预期数据的访问(即整个链的完整区块头)。

测试套件应该使用 Tendermint RPC 客户端和 Tendermint 轻客户端，来练习客户端代码。

### 实施注意事项

测试网应在 Docker Compose 中运行，包括本地和 CI。这使得在本地重现测试失败变得更容易。支持多个测试运行器(例如在 VM 或 Kubernetes 上)超出了范围。所有测试都应使用相同的映像，并通过已安装的卷传递配置。

似乎没有任何现成的解决方案可以为我们做到这一点，因此我们必须在 Docker Compose 之上推出我们自己的解决方案。这给了我们更大的灵活性，但估计需要几周的时间。

应通过 YAML 文件配置测试网。这些用作测试运行器的输入，例如从它们生成 Docker Compose 配置。顶部的附加层应从 YAML 文件生成这些测试网配置，该文件指定要测试的所有选项组合。

综合测试网应该每晚针对主节点运行。但是，应该为每个拉取请求运行一小部分代表性测试网，例如具有状态同​​步和快速同步的四节点 IPv4 网络。

应该使用标准 Go 测试框架(和例如 Testify)编写测试，并使用辅助函数从测试配置中获取信息。测试运行器将为每个网络节点单独运行测试，并且测试必须根据节点的配置改变其预期。

应该可以启动特定的测试网并从 IDE 或本地终端针对它运行单个测试用例。

如果可能，应扩展现有的“testnet”命令以设置端到端测试所需的网络拓扑。

## 状态

实施的

## 结果

### 积极的

- 基本 Tendermint 功能的全面端到端测试覆盖率，以与用户相同的方式执行通用代码路径

- 测试环境可以轻松地在本地复制并通过标准工具进行调试

### 消极的

- 共识正确性测试的覆盖范围有限(例如 Jepsen)

- 不涉及恶意或对抗性行为

- 必须推出我们自己的测试框架，这需要工程资源

- 可能会降低 CI 时间，具体取决于运行的测试

- 运营成本和管理费用，例如基础设施成本和系统维护

### 中性的

- 不支持替代基础设施平台，例如Kubernetes 或虚拟机

## 参考

- [#5291: 新的端到端测试套件](https://github.com/tendermint/tendermint/issues/5291)
