# RFC 006:事件订阅

## 变更日志

- 2021 年 10 月 30 日:初稿 (@creachadair)

## 抽象的

Tendermint 共识节点允许客户端订阅其事件流
通过其 RPC 服务上的方法。查看事件流的能力是
对客户有价值，但目前的实施有一些不足之处
使一些客户难以有效使用。该 RFC 记录了这些
问题并讨论解决这些问题的可能方法。


## 背景

正在运行的 Tendermint 共识节点导出 [JSON-RPC 服务][rpc-service]
它提供了[大量方法][rpc-methods] 用于检查和
与节点交互。这些方法的一个重要集群是
`subscribe`、`unsubscribe` 和 `unsubscribe_all` 方法，允许客户端
订阅[节点生成的事件][事件]的过滤流
当它运行时。

与服务的其他方法不同，“事件”中的方法
订阅”集群无法通过 [普通 HTTP GET 或 POST
requests][rpc-transport]，但需要将 HTTP 连接升级到
[网络套接字] [ws]。这是必要的，因为`subscribe` 请求需要一个
将结果传递回客户端的持久通道，以及一个普通的 HTTP
连接不能在多个请求中可靠地持续存在。由于这些
如果没有持久通道，方法将无法正常工作，它们是_only_
通过 websocket 连接导出，并且不会为纯 HTTP 路由。


## 讨论

当前的事件实现存在一些操作问题
RPC 服务中的订阅:

- **事件传递不是有效的 JSON-RPC。** 当客户端发出`subscribe`
  请求，服务器以初始空确认回复(正确)
  (`{}`)。之后，每个匹配的事件都会“主动提供”(没有
  来自客户端的另一个请求)，作为单独的 [响应对象][json-response]
  具有与初始请求相同的 ID。

  这很重要，因为这意味着标准的 JSON-RPC 客户端库不能
  与事件订阅机制正确交互。

  即使对于可以处理服务器推送的未经请求的值的客户端，
  这些响应是无效的:它们有一个 ID，所以它们不能被视为
  [通知][json-notify];但 ID 对应于一个请求
  已经完成。在实践中，这意味着通用 JSON-RPC
  库无法正确使用此方法——它需要自定义客户端。

  Tendermint 核心的 Go RPC 客户端可以支持这种情况，但是客户端
  在其他语言中没有简单的解决方案。

  这是问题 [#2949][issue2949] 的原因。

- **订阅因断开连接而终止。** 当连接到
  客户端被中断，订阅被悄悄删除。

  这是一种合理的行为，但这很重要，因为客户
  订阅被删除没有得到有用的错误反馈，只是一个关闭
  联系。他们应该再试一次吗？节点是否过载？是客户
  太慢了？来电者是否忘记响应 ping？调试这些类型
  失败是不必要的痛苦。

  Websockets 复杂化了这一点，因为如果没有，websocket 连接就会超时
  一段时间内可以看到流量，保持它们活着需要主动
  客户端和服务器之间的合作。使用普通的 TCP 套接字，活跃度
  由 keepalive 机制透明地处理。在网络套接字上，
  但是，一侧必须偶尔发送 PING(如果连接是
  否则闲置)。对方必须及时返回匹配的PONG，否则
  连接断开。除了乏味之外，这很容易受到影响
  到 CPU 负载。

  Tendermint Go 实现会自动发送和响应 ping。
  其他语言的客户端(或不想使用 Tendermint 库)
  需要明确处理它。这给客户带来了不切实际的负担
  好处:订阅者没有关于匹配事件何时可能发生的信息
  可用，所以它不应该参与保持连接
  活。

- **不匹配的负载配置文件。** 大多数 RPC 服务主要对
  低容量本地使用，或者由节点服务的应用程序(例如，
  ABCI 方法)或节点操作符(例如，信息方法)。事件
  订阅对于远程客户端很重要，并且可能代表更高的
  流量。

这很重要，因为两者都使用相同的 JSON-RPC 机制。为了
  低容量本地使用，JSON-RPC 的人体工程学非常适合:它很容易
  从命令行发出查询(例如，使用 `curl`)或编写脚本
  调用 RPC 方法来监视正在运行的节点。

  对于大量远程使用，JSON-RPC 不太适合:即使离开
  除了上面提到的非标准交付协议，时间和内存
  编码事件数据的成本对节点的稳定性很重要，当
  可能有数百个订阅者。此外，订阅是
  与大多数 RPC 方法相比，它是长期存在的，因为它可以持续存在
  节点处于活动状态。

- **不匹配的安全配置文件。** RPC 服务导出了几种方法
  不应该对任意远程调用者开放，无论是为了正确性
  原因(例如，`remove_tx` 和 `broadcast_tx_*`)和操作
  稳定性原因(例如，`tx_search`)。一个节点可能仍然需要暴露
  事件，但是，以支持 UI 工具。

  这很重要，因为所有方法共享相同的网络端点。尽管
  可以使用代理阻止顶级 GET 和 POST 处理程序，
  暴露 `/websocket` 处理程序会暴露_only_事件订阅
  方法，但其余的服务也是如此。

### 可能的改进

我们可以做几件事来改善开发人员的体验
谁需要从共识节点订阅事件。这些还不是全部
互斥。

1. **将事件订阅拆分为单独的服务**。而不是暴露
   与 RPC 服务的其余部分在同一端点上的事件订阅，
   在节点上为 _only_ 事件订阅专用一个单独的端点。这
   其余的 RPC 服务(_sans_ 事件)将保持原样。

   这将很容易禁用或防火墙外部访问敏感
   RPC 方法，不会阻止对事件订阅的访问(反之亦然)。
   这可能是值得做的，即使我们不采取任何其他步骤
   在这里描述。

2. **使用不同的协议进行事件订阅。** 有多种方式
   我们可以解决这个问题，这取决于我们愿意改变的程度
   当前 API。以下是一些选项的草图:

   - 保留 websocket，但重新设计 API 以更符合 JSON-RPC，
     也许通过将事件传递转换为通知。这是少
     现有客户的前期更改，但保留所有现有的
     实现的复杂性，并且对更严重的贡献不大
     稍后进行性能和用户体验改进。

   - 从 websocket 切换到普通 HTTP，并将订阅 API 重新设计为
     使用更传统的请求/响应模式而不是流式传输。
     对于现有客户来说，这是一项更多的前期工作，但可以利用
     为不是用 Go 编写的客户端提供更好的库支持。

     该协议将变得更加健谈，但我们可以通过
     批处理，作为回报，我们可以更好地控制要做什么
     慢速客户端:而不是像我们现在所做的那样默默地放弃它们，我们
     可能会丢弃消息并通知客户端他们错过了一些数据(“M
     自上次轮询以来丢弃的消息”)。

     此选项可能是工作、API 更改和
     好处，并且有一个很好的附带效果，它会更容易调试
     从命令行订阅，就像其他 RPC 方法一样。

- 切换到 gRPC:保留持久连接并为我们提供更多
     高效的二进制线格式 (protobuf)，代价是为
     客户端和更难调试。如果性能好，这可能是最好的选择
     和服务器负载是我们最关心的问题。

     鉴于我们目前正在使用 JSON-RPC，但是，我不相信
     在事件订阅频道上编码和发送消息的成本
     然而，是订阅效率的限制因素。

3. **将事件订阅委托给代理。** 负责
   管理与节点分开运行的代理的事件订阅，
   并切换节点以将事件推送到代理(如 webhook)而不是
   直接为订阅者提供服务。这对操作员来说是更多的工作(另一个
   配置和运行的过程)，但可以更好地扩展大型网络。

   为了完整性，我提到了这个选项，但进行此更改将是一个
   相当可观的项目。如果我们要考虑转移责任
   无论如何，对于节点外的事件订阅，我们可能应该更多
   系统地介绍它。有关更原则性的方法，请参见下面的第 (4) 点。

4. **将事件订阅移动到索引下游。** 我们已经在计划
   使应用程序可以更好地控制事件索引。引申开来，我们
   可能允许应用程序还控制过滤事件的方式，
   查询，并订阅。让应用程序控制这些问题，
   而不是节点，可能会让开发人员更轻松地构建 UI 和
   该应用程序的工具。

   这是一个更大的变化，所以我认为它不太实用
   在短期内，但作为更广泛的选择值得考虑。一些
   可以使现有的过滤和选择代码更具可重用性，
   所以应用程序不需要重新发明一切。


## 参考

- [Tendermint RPC 服务][rpc-service]
- [Tendermint RPC 路由][rpc-methods]
- [事件系统讨论][事件]
- [关于 RPC 传输选项的讨论][rpc-transport](来自 RFC 002)
- [RFC 6455:websocket 协议][ws]
- [JSON-RPC 2.0 规范](https://www.jsonrpc.org/specification)

[rpc-service]:https://docs.tendermint.com/master/rpc/
[rpc-方法]:https://github.com/tendermint/tendermint/blob/master/internal/rpc/core/routes.go#L12
[事件]:./rfc-005-event-system.rst
[rpc-transport]:./rfc-002-ipc-ecosystem.md#rpc-transport
[ws]:https://datatracker.ietf.org/doc/html/rfc6455
[json-response]: https://www.jsonrpc.org/specification#response_object
[json-notify]:https://www.jsonrpc.org/specification#notification
[issue2949]:https://github.com/tendermint/tendermint/issues/2949
