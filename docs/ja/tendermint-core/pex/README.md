# ピアツーピア戦略とコミュニケーション

ここでは、PeerStoreの設計の概要を説明します
そして、Peer Exchange Reactor(PEX)がそれをどのように使用して接続を確保するか
良い仲間への仲間と他の人へのうわさ話。

## ピアタイプ

一部のピアの特殊性は、ユーザーによって「永続的」として指定されていることです。
これは、接続が失敗した場合、またはダイヤルに失敗した場合、自動的にリダイヤルすることを意味します
彼ら。
一部のピアは「プライベート」としてマークできます。これは、
私たちはそれらを私たちの仲間の店に置いたり、他の人にゴシップしたりしません。

プライベートピアとそのピアを除くすべてのピアが使用します
コンパニオンストア。

他のピアとの唯一の違いは次のとおりです。
インバウンド(彼らは私たちのパブリックアドレスと呼びます)またはアウトバウンド(私たちは彼らと呼びます)。

## 探す

ピア検出はシードリストから始まります。

仲間が足りないときは

1.既存の同僚に尋ねる
2.現在誰にも電話していない場合は、シードに電話してください

起動時に、指定された「persistent_peers」リストにもすぐにダイヤルします。
そして、それらとの永続的な接続を維持しようとします。もしも
接続が中断されるか、ダイヤルが失敗した場合、5秒ごとに数分リダイヤルします。
次に、約1日後に指数バックオフプランに切り替えます
ダイヤルピアを停止してみてください。この動作は、 `persistent_peers_max_dial_period`がゼロに設定されている場合です。

ただし、 `persistent_peers_max_dial_period`がゼロより大きい値に設定されている場合、各永続ピアへの各ダイヤル間の条件
インデックスのバックオフ期間中は、「persistent_peers_max_dial_period」を超えることはありません。
したがって、 `dial_period` = min(` persistent_peers_max_dial_period`、 `exponential_backoff_dial_period`)
`maxAttemptsToDial`に関係なく、引き続き試行します

`MaxNumOutboundPeers`未満である限り、定期的にリクエストします
私たち一人一人からの他の仲間とシードを試してみてください。

## 聞く

ピアは構成可能なListenAddrをリッスンし、
他のピアとのハンドシェイク中のNodeInfo。仲間に最も受け入れられている
`MaxNumInboundPeers`着信ピア。

## 住所録

ピアはID(PubKey.Address())によって追跡されます。
ピアは、最初に接続したときにPEXからピアストレージに追加されます。
他の同僚からそれらについて聞いたとき。

ピアストアはバケットセットに従って配置され、区別されます
調査済み(古い)および無修正(新しい)ピア。異なるバケットグループを保持します
調査され、検閲されていないピア。バケットは、ピア選択のランダム化を提供します。
ピアは、IPグループに従ってバケットに配置されます。

IPグループは、マスクIP(たとえば、「1.2.0.0」または「2602:100 ::」)または「ローカル」にすることができます。
ローカルアドレスまたはルーティング不可能なアドレスの場合は「ルーティング不可」。あのマスク
IPv4の場合は `/16`サブネット、IPv6の場合は`/32`サブネットに対応します。
各グループには、防止するための限られた数のバケットがあります
グループ(たとえば、攻撃者は「/16」IPブロックを購入し、DoSを開始しました
攻撃)。

[highwayhash](https://arxiv.org/abs/1612.06257)をハッシュ関数として使用
バケットを計算するとき。

ノードを新しいバケットに配置する場合:

```md
hash(key + sourcegroup + int64(hash(key + group + sourcegroup)) % bucket_per_group) % num_new_buckets
```

ピアを古いバケットに入れる場合:

```md
hash(key + group + int64(hash(key + addr)) % buckets_per_group) % num_old_buckets
```

その中で、 `key`-ランダムな24 HEX文字列、` group`-ピアのIPグループ(たとえば、 `1.2.0.0`)、
`sourcegroup`-送信者のIPグループ(このアドレスを送信したピア)(例:` 174.11.0.0`)、
`addr`-ピアアドレスの文字列表現(例:` 174.11.10.2:26656`)。

精査されたピアは、1つのバケットにのみ存在できます。無修正のピアは複数のバケットに存在する可能性があり、
ピアの各インスタンスは、異なるIP:PORTを持つことができます。

新しいピアを追加しようとしたが、バケットにスペースがない場合は、
最悪のピアをバケットから削除して、スペースを確保します。

## レビュー

ピアが初めて追加されたとき、それは無修正でした。
ピアを打ち切りとしてマークすることは、p2pパッケージの範囲を超えています。
テンダーミントの場合、ピアが十分な貢献をした後、レビューされます
コンセンサスレベルで; IE。有効で未知の情報が送信されたら
「NumBlocksForVetted」ブロックの投票および/またはブロック部分。
p2pパッケージの他のユーザーは、ピアにレビューのマークを付けることができるように、自分の条件を決定できます。

ピアが検閲されているが、検閲されたピアがすでに多すぎる場合、
ランダムに選択された精査されたピアの1つが無修正になります。

ピアが無修正になった場合(新しいピア、または以前に精査されたピア)、
ランダムに選択された打ち切りのないピアノードの1つが、ピアストレージから削除されます。

よりきめ細かいピアツーピア行動追跡を使用できます
信頼の指標(以下を参照)ですが、簡単なことから始めるのが最善です。

## ダイヤルするピアを選択します

より多くのピアが必要な場合は、addrbookからいくつかのアドレスをランダムに選択します
打ち切られていないピアの構成可能な偏差。時々、偏差はもっと低くなるはずです
ピアが少なくなり、増えるにつれて増える可能性があり、最初のピアが確実になります
より信頼できますが、常に新しくて良いものを発見する機会を与えてくれます
ピア。

ピアへの最後の呼び出しの時間と失敗した試行の数を追跡します
私たちはそれをしました。試行回数が多すぎる場合は、ピアを不良としてマークします。

接続の試行は、指数バックオフ(およびジッター)を介して行われます。なぜなら
選択プロセスは `ensurePeersPeriod`ごとに行われます。終了しない場合があります
ピアにダイヤルする時間は、バックオフ期間よりもはるかに長くなります。

16回の試行後にピアへの接続に失敗した場合(指数バックオフを使用)、
ピアツーピアストアから完全に削除されました。しかし、忍耐強い同僚のために、私たちは無期限に試みます
`persistent_peers_max_dial_period`がゼロに設定されていない限り、すべての永続ピアにダイヤルします

## 交換するピアを選択します

ピアの提供を求められた場合、次のように選択します。

-最大で `maxGetSelection`ピアを選択します
-少なくとも `minGetSelection`ピアを選択してみてください-この値よりも小さい場合は、すべてを選択してください。
-ランダムで偏りのない「getSelectionPercent」ピアを選択します

選択したピアを送信します。ピアに対して公平なレビュー/非レビューを実施することを選択していることに注意してください。

## スパムを防ぐ

さまざまな状況で、ピアは誤動作しており、ピアから切断されていると考えられます。
これが発生すると、ピアはピアストレージから削除され、ブラックリストに登録されます
しばらくの間。これを「切断してマーク」と呼びます。
PEXリアクター自体の外部で不正な動作が検出される場合があることに注意してください
(例:mconnectionまたは別のリアクター内)、ただし、PEXリアクターと通信する必要があります
したがって、ピアを削除してマークを付けることができます。

PEXでは、ピアが一方的なピアのリストを送信した場合、
または、ピアが別のリクエストの後にリクエストを送信するのが速すぎる場合は、
MarkBadから切断します。

## 信頼指標

ピアの品質は、よりきめ細かい詳細で追跡できます
比例積分微分(PID)コントローラーには次のものが含まれます
ピアの品質を通知するための現在、過去、および変更率のデータ。

PIDトラストメトリックは実装されていますが、それでも将来の作業が必要です
PEXで使用します。

[trustmetric](https://github.com/tendermint/tendermint/blob/master/docs/architecture/adr-006-trust-metric.md)を参照してください
そして[trustmetricuseage](https://github.com/tendermint/tendermint/blob/master/docs/architecture/adr-007-trust-metric-usage.md)
詳細については、アーキテクチャのドキュメントを参照してください。





<！-todo:図!!!->
