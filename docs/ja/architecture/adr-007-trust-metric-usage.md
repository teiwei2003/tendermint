# ADR 007:信頼指標を使用するためのガイドライン

## 環境

Tendermintは、ピアツーピアダイヤリングおよびピアツーピアスイッチングポリシーを通知するために、ピアツーピアの品質を監視する必要があります。

ノードが初めてネットワークに接続するときは、適切なピアをすばやく見つけることができることが重要です。
したがって、ノードの接続数は少なくなりますが、より高品質のピアに優先的に接続する必要があります。
ノードがネットワークの他の部分と適切に接続されている場合、ノードはあまり知られていない、または少ないと呼ぶことができます
質の高い仲間とその質の評価を支援します。同様に、ピアにクエリを実行する場合、ノードは次を使用する必要があります
質の低い仲間に戻らないように注意してください。

特定の動作を良好または不良としてマークするトラストメトリックを使用して、ピアの品質を追跡できます。十分な場合
悪い振る舞いが蓄積し、ピアを悪いものとしてマークして切断することができます。
たとえば、PEXReactorが既知のピアからピアのネットワークアドレスを要求し、返されたネットワークアドレスにアクセスできない場合、この不正な動作を追跡する必要があります。間違ったネットワークアドレスを返してもピアが削除されない場合があります。この動作が多すぎると、ピアが削除の対象になります。オリジナルの信頼測定方法と設計ドキュメントは、[ADR 006](adr-006-trust-metric.md)にあります。

信頼測定の実装により、開発者は信頼測定ストアからピアの信頼測定を取得し、ピアの動作に関連する良いイベントと悪いイベントを追跡し、いつでもピア測定を照会して現在の信頼値を取得できます。 。現在の信頼値は、現在の動作、以前の動作、および2つの間の変更を使用する式を使用して計算されます。現在の動作は、時間間隔内の良好な動作のパーセンテージとして計算されます。時間間隔は短く、30秒から5分の間で設定できます。一方、履歴データは、数日間の追跡中のピアの動作を推定できます。時間間隔が終了すると、現在の動作が履歴データの一部になり、新しい時間間隔が開始され、良好なカウンターと不良なカウンターがゼロにリセットされます。

信頼インジケーターが時間間隔とスコアリングをどのように処理するかに関して、次の重要な点に留意する必要があります。

-すべての新しい時間間隔は満点で始まります
-悪いイベントはすぐにスコアを下げ、良いイベントはスコアをゆっくりと上げます
-時間間隔が終了すると、良好なイベントの割合が履歴データになります。

トラストメトリックの内部動作に関するいくつかの有用な情報:

-信頼メトリックが初めてインスタンス化されると、タイマー(自動ティッカー)が定期的にトリガーされ、信頼メトリックの時間間隔間の遷移を処理します。
-ピアがノードから切断されている場合、ノードがピアに接続されていないため、タイマーを一時停止する必要があります
-ストア** PeerDisconnected **メソッドとメトリック** Pause **メソッドは、インジケーターを一時停止する機能をサポートします
-一時停止後、インジケーターで良いまたは悪いイベントメソッドが呼び出されると、一時停止が自動的にキャンセルされ、新しい時間間隔が開始されます。

## 決定

信頼度測定機能が利用できるようになりましたが、それでも疑問が残ります。つまり、ピアの品質を正しく追跡するために、Tendermint全体にどのように適用する必要があるのでしょうか。

### 提案されたプロセス

アドレスブックとトラストメトリックを使用して、ピアリングポイントを管理します。

-名簿は仲間を記録し、選択方法を提供します
-トラストメトリックはピアの品質を追跡します

#### 名簿に存在する

アウトバウンドピアは、ダイヤルする前にアドレスブックに追加されます。
ピアリング接続が確立されると、インバウンドピアが追加されます。
ピアからの応答を受信すると、それもアドレス帳に追加されます
pexRequestMessage。

ノードが `needAddressThreshold`未満の場合、定期的にそれ以上を要求します。
pexRequestMessageを介して、ランダムに選択されたピアおよび新しくダイヤルされたアウトバウンドピアから。

名簿に新しい住所が追加され、その住所が `0.5 * needAddressThreshold`を超えた場合、
次に、ランダムに選択された低品質のピアを低い確率で削除します。

#### アウトバウンドピア

ピアは、次の方法で最小数のアウトバウンド接続を維持しようとします。
接続するピアのアドレス帳を繰り返し照会します。
ノードにはアウトバウンド接続がほとんどありませんが、アドレス帳は返される傾向があります
高品質の対応物。ノードがアウトバウンド接続の数を増やすと、
名簿は、検閲が少ないか質が低い仲間に戻る傾向があります。

#### インバウンドピア

ピアは、MaxNumPeersの接続の最大総数も維持します。
ピアにMaxNumPeersがある場合、ピアは低い確率で新しい着信接続を受け入れます。
このような新しい接続を受け入れると、ピアは確率的に選択された下位のピアから切断されます
したがって、MaxNumPeersを超えることはありません。

#### ピア交換

ピアがpexRequestMessageを受信すると、アドレスブックから高品質のピアのサンプルをランダムに返します。 pexRequestMessageへの応答には、スコアがないか低いピアを含めるべきではありません。

#### ピア品質

TrustMetricをピアに保存する
スレッドセーフなデータストレージ。

ピアツーピアの動作は、次のいずれかとして定義されます。

-致命的-完全に悪意のあるものが原因で、ピアが切断され、一定期間アドレス帳から禁止されます
-悪い-あらゆる種類のタイムアウト、マーシャリングされていないメッセージ、他の有効性チェックに合格しなかったメッセージ、または要求または予期しなかったメッセージ(通常は悪いイベントの価値があります)
-ニュートラル-不明なチャネル/メッセージタイプ/バージョンのアップグレード(良いイベントまたは悪いイベントは記録されていません)
-正しい-通常の正しい動作(良いイベントに値する)
-良い-各リアクターのピアのランダムな過半数が有用なメッセージを送信します(複数の良いイベントの価値があります)。

致命的な行動はピアを削除しますが、中立的な行動はスコアに影響を与えないことに注意してください。

## ステータス

提案しました。

## 結果

### ポジティブ

-名簿とトラストメトリックストレージを組み合わせることで、セキュリティと信頼性を高める方法でネットワークを構築できます。

### ネガティブ

-決断される

### ニュートラル

-この実装を使用するには、悪いイベントと同じように、良いイベントを記録する必要があることに注意してください。
