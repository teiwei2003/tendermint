# ADR 66:エンドツーエンドのテスト

## 変更ログ

-2020年9月7日:最初のドラフト(@erikgrinaker)
-2020-09-08:小さな改善(@erikgrinaker)
-2021-04-12:RFC 001(@tessr)から名前が変更されました

## 著者

-Eric Greenac(@erikgrinaker)

## 環境

「test /」の下に設定されている現在のエンドツーエンドテストは非常に限られており、主に標準構成でのP2Pテストに焦点を当てています。さまざまな構成(高速同期リアクターバージョン、状態同期、ブロックプルーニング、ジェネシスとInitChain設定など)をテストしたり、さまざまなネットワークトポロジ(センチネルノードアーキテクチャなど)をテストしたりしません。これにより、テストカバレッジが低くなり、いくつかの重大なエラーが無視されることになります。

構成オプション、作成設定、ネットワークトポロジ、ABCIの相互作用、および障害シナリオの多数の組み合わせを実行し、ネットワークがまだ機能しているかどうかを確認できるエンドツーエンドのテストスイートが必要です。このADRは、そのようなシステムの基本的な要件と設計の概要を示しています。

このADRは、包括的なカオステストをカバーしていませんが、いくつかの単純なシナリオ(たとえば、プロセスの突然の終了やネットワークのパーティション分割)のみをカバーしています。コアコンセンサスアルゴリズムのカオステストは、Jepsenテストや同様のフレームワークなどを介して実装するか、後でこれらのエンドツーエンドテストに追加する必要があります。同様に、悪意のあるまたは敵対的な動作は最初の実装の範囲を超えていますが、後で追加される可能性があります。

## 提案

### 機能カバレッジ

テストしたい機能を以下に示します。

#### 周辺

-**トポロジ:**シングルノード、4ノード(シードおよび永続)、センチネルアーキテクチャ、NAT(UPnP)
-**ネットワーク:** IPv4、IPv6
-** ABCI接続:** UNIXソケット、TCP、gRPC
-** PrivVal:**ファイル、UNIXソケット、TCP

#### ノード/アプリケーションの構成

-**データベース:** goleveldb、cleveldb、boltdb、rocksdb、badgerdb
-**クイック同期:**無効、v0、v2
-**ステータスの同期:**無効、有効
-**ブロックトリム:**なし、20を維持、1を維持、ランダムを維持
-**役割:**ベリファイア、フルノード
-**アプリケーションの永続性:**有効、無効
-**ノードモード:**バリデーター、コンプリート、ライト、シード

#### 遺伝子

-**バリデーター:**なし(InitChain)、指定
-**初期の高さ:** 1、1000
-**アプリケーションステータス:**なし、指定

#### 行動

-**再開:**停止/開始、電源の入れ直し、検証者の中断、ネットワークパーティション、ネットワーク損失の合計
-**ベリファイア:**パワーの追加、削除、変更
-**証拠:** DuplicateVoteEvidenceとLightClientAttackEvidenceを挿入します

### 機能の組み合わせ

上記の関数は数百万個あるため、上記の関数のすべての組み合わせに対して個別のテストを実行することはできません。ただし、機能は3つの主要なカテゴリに分けることができます。

-**グローバル:**ネットワーク全体に影響します。組み合わせごとに個別のテストネットワーク(トポロジ、ネットワークプロトコル、作成設定など)が必要です。

-**ローカル:**は単一のノードに影響し、テストネットワークの各ノードで変更できます(ABCI /プライベート接続、データベースバックエンド、ブロックプルーニングなど)

-**一時的:**同じテストネットワークで順次実行できます(例:リカバリとバリデーターの変更)

したがって、グローバルオプションのすべての組み合わせ(約100)に対して個別のテストネットを実行できます。各テストネットでは、広範囲に最適化されたランダムに生成されたノード構成でノードを実行します(つまり、1つのノードがGoLevelDBを使用している場合、可能であれば、他のノードはそれを使用しないでください)。各テストネットでは、ノードをランダムに選択して、停止/開始、再起動、追加/削除、切断などを行います。

CIから取得してローカルでデバッグできるように、すべての設定をテストネット構成(またはそれを生成したシード)で指定する必要があります。

必要な動作(たとえば、バリデーターの変更、ブロックのトリミング、永続性の有効化/無効化など)を示すカスタムABCIアプリケーションを構築する必要があります。

### テストフェーズ

テスト構成を考えると、テストランナーには次の段階があります。

-**セットアップ:** Dockerコンテナーとネットワークを構成しますが、起動しないでください。

-**初期化:** Dockerコンテナーを起動し、高速同期/状態同期を実行します。さまざまな開始高さに適応します。

-**妨害:**バリデーターの追加/削除、ノードの再起動、ネットワークの妨害など。-各操作間の活性と準備状況を確認します。

-**テスト:**すべてのネットワークノードに対して独立してRPCテストを実行し、データが期待を満たし、変更されていないことを確認します。

### テスト

一般的な方法は、ネットワークに一連の操作(上記の段階を参照)を実行させ、各操作の後に基本的なアクティビティと準備状況を確認し、ネットワークが安定した後、ネットワーク内の各ノードに対してRPCテストスイートを実行することです。

テストスイートは、単一ノードのRPCサービスでブラックボックステストを実行します。高速同期ノードがチェーンヘッドに正しく追いつき、RPCを介して基本ブロックデータを提供するなど、ネットワーク全体の動作をテストします。したがって、テストは、たとえばP2Pメッセージを送信したり、ノードデータベースをチェックしたりしません。これらは内部実装の詳細と見なされるためです。ネットワークが正しく動作している場合、内部コンポーネントは正常に機能している可能性があります。包括的なコンポーネントテスト(たとえば、各RPCメソッドパラメータ)は、ユニット/統合テストを通じて実行する必要があります。

テストでは、ノード構成を考慮する必要があり(たとえば、一部のノードがプルーニングされ、他のノードがバリデーターではない場合があります)、何らかの方法で期待されるデータへのアクセスを提供する必要があります(つまり、チェーン全体の完全なブロックヘッダー)。

テストスイートでは、TendermintRPCクライアントとTendermintlightクライアントを使用してクライアントコードを練習する必要があります。

### 実装上の注意

テストネットは、ローカルとCIを含め、DockerComposeで実行する必要があります。これにより、テストの失敗をローカルで再現しやすくなります。複数のテストランナー(VMやKubernetesなど)をサポートすることはできません。すべてのテストで同じイメージを使用し、マウントされたボリュームを介して構成をパスする必要があります。

これを実行できる既存のソリューションはないようです。そのため、DockerComposeの上に独自のソリューションを起動する必要があります。これにより柔軟性が高まりますが、数週間かかると推定されています。

テストネットはYAMLファイルを介して構成する必要があります。これらは、テストランナーへの入力として使用されます。たとえば、それらからDockerCompose構成を生成します。最上位の追加レイヤーは、テストするオプションのすべての組み合わせを指定するYAMLファイルからこれらのテストネット構成を生成する必要があります。

包括的なテストネットワークは、マスターノードに対して毎晩実行する必要があります。ただし、状態同期と高速同期を備えた4ノードのIPv4ネットワークなど、プルリクエストごとに小さな代表的なテストネットを実行する必要があります。

テストは、標準のGoテストフレームワーク(たとえば、Testify)を使用して作成する必要があり、ヘルパー関数を使用してテスト構成から情報を取得します。テストランナーはネットワークノードごとに個別にテストを実行し、テストはノードの構成に基づいて期待値を変更する必要があります。

特定のテストネットを起動し、IDEまたはローカル端末からそれに対して単一のテストケースを実行できるはずです。

可能であれば、既存の「testnet」コマンドを拡張して、エンドツーエンドのテストに必要なネットワークトポロジを設定する必要があります。

## ステータス

実装

## 結果

### ポジティブ

-基本的なTendermint関数の包括的なエンドツーエンドのテストカバレッジ。ユーザーと同じ方法で一般的なコードパスを実行します。

-テスト環境はローカルに簡単にコピーでき、標準ツールでデバッグできます

### ネガティブ

-コンセンサス正しさテストの対象範囲は限られています(例:ジェプセン)

-悪意のあるまたは対立的な行動を伴わない

-エンジニアリングリソースを必要とする独自のテストフレームワークを起動する必要があります

-テストの実行によっては、CI時間が短縮される場合があります

-インフラストラクチャコストやシステムメンテナンスなどの運用コストと管理コスト

### ニュートラル

-Kubernetesや仮想マシンなどの代替インフラストラクチャプラットフォームをサポートしていません

## 参照する

-[#5291:新しいエンドツーエンドのテストスイート](https://github.com/tendermint/tendermint/issues/5291)
