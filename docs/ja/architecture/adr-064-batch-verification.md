# ADR 064:バッチ検証

## 変更ログ

-2021年1月28日:作成(@ marbar3778)

## 環境

Tendermintは、公開鍵秘密鍵暗号化を使用して検証者に署名します.ブロックが提案され、検証者がブロックの受け入れを示すメッセージに署名するために投票された場合、ゼロ投票は拒否を示します.ノードが同期している場合、これらの署名は、前のブロックが正しいことを確認するためにも使用されます.現在、Tendermintでは、各署名を個別に検証する必要があります.これにより、ブロックの生成時間が遅くなります.

バッチ検証は、多くのメッセージ、キー、および署名を一緒に追加し、それらを同時に検証するプロセスです.公開鍵は同じでもかまいません.この場合、1人のユーザーが複数のメッセージに署名していることを意味します.この例では、各公開鍵は一意であり、各検証者には独自のメッセージがあり、一意のメッセージを提供します.アルゴリズムは曲線ごとに異なる場合がありますが、パフォーマンス上の利点は、単一の検証メッセージ、公開鍵、および署名で共有されます.

## 代替方法

-署名の集約
  -署名の集約は、バッチ検証の代替手段です.署名の集約により、検証が高速になり、ブロックサイズが小さくなります.このADRを書いている時点で、Tendermintで署名の集約を有効にする作業が進行中です.現時点で導入しないことを選択した理由は、各検証者が固有のメッセージに署名するためです.
  一意のメッセージに署名すると、検証前の集約が防止されます.たとえば、BLSを使用して署名の集約を実装する場合、検証速度は10倍から100倍低下する可能性があります.

## 決定

バッチ検証を使用します.

## 詳細設計

新しいインターフェースが導入されます.このインターフェースには、 `NewBatchVerifier`、` Add`、 `VerifyBatch`の3つのメソッドがあります.

```go
type BatchVerifier interface {
  Add(key crypto.Pubkey, signature, message []byte) error // Add appends an entry into the BatchVerifier.
  Verify() bool // Verify verifies all the entries in the BatchVerifier. If the verification fails it is unknown which entry failed and each entry will need to be verified individually.
}
```

-`NewBatchVerifier`は新しいベリファイアを作成します. このバリデーターは、検証されるエントリにデータを入力します.
-`Add`はバリデーターにエントリを追加します. Addは、公開鍵と2バイトのスライス(署名とメッセージ)を受け入れます.
-`Verify`はすべてを検証します. 検証の最後に、基盤となるAPIがバリデーターを初期状態(空)にリセットしなかった場合は、ここで行う必要があります. これにより、以前に検証されたエントリを持つバリデーターが誤って再利用されるのを防ぎます.

エントリは上記で言及されました. 基礎となる曲線のニーズに応じて、エントリはさまざまな方法で作成できます. 簡単な方法は次のとおりです.

```go
type entry struct {
  pubKey crypto.Pubkey
  signature []byte
  message []byte
}
```

このアプローチを採用する主な理由は、単純なミスを防ぐためです. 一部のAPIでは、ユーザーが3つのスライスを作成して「VerifyBatch」関数に渡すことができますが、これはユーザーがすべてのスライスを安全に生成することに依存しています(以下の例を参照). エラーの可能性を最小限に抑えたいと考えています.

```go
func Verify(keys []crypto.Pubkey, signatures, messages[][]byte) bool
```

検証時間が短縮されることに加えて、この変更はどのユーザーにも影響を与えません.

この新しいAPIは、コンセンサスとブロック同期の検証に使用されます.現在の検証機能では、キータイプがBatchVerificationAPIをサポートしているかどうかがチェックされます.その場合はバッチ検証を実行し、そうでない場合は単一署名検証を使用します.

#### コンセンサス

  コンセンサスプロセスは、2/3以上の投票の受信を待機します.受信されると、「Verify()」が呼び出され、すべてのメッセージがバッチで検証されます. 2/3以降に受信したメッセージは個別に検証されます.

#### ブロック同期とライトクライアント

  ブロック同期とライトクライアント検証のプロセスは、バッチモードで2/3 +のみを検証します.これらのプロセスはコンセンサスに参加しないため、メッセージが増えるのを待つ必要はありません.

何らかの理由でバッチ検証が失敗した場合、どのエントリが失敗の原因であるかはわかりません.検証は、単一署名の検証に戻す必要があります.

最初は、ed25519のみがバッチ検証をサポートします.

## ステータス

実装

### ポジティブ

-曲線がサポートしている場合は、検証時間が短縮されます

### ネガティブ

-どのキー検証が失敗したかを確認できません
  -失敗とは、単一の署名検証に戻ることを意味します.

### ニュートラル

## 参照する

[Ed25519ライブラリ](https://github.com/hdevalence/ed25519consensus)
[Ed25519仕様](https://ed25519.cr.yp.to/)
[署名集計投票](https://github.com/tendermint/tendermint/issues/1319)
[提案者のタイムスタンプに基づく](https://github.com/tendermint/tendermint/issues/2840)
