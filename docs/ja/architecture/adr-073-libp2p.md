# ADR 073:LibP2Pを採用

## 変更ログ

-2021-11-02:最初のドラフト(@tychoish)

## ステータス

提案しました.

## 環境


0.35開発サイクルの一環として、Tendermintチームは完了しました
ADR 61および62で説明されている作業の最初のフェーズには、次のものが含まれます.
リアクターとp2pメッセージの大規模なリファクタリング
ルーティング.これは、スイッチや他の多くの伝統に取って代わります
プロトコルまたはネットワークレベルのコンポーネントを壊さない
相互運用性とレガシー接続/ソケット処理コードを残します.

リリース後、チームはコードのステータスを再確認しました
そして、デザイン、そしてテンダーミントの要件.ノート
[P2Pロードマップにあります
RFC] [RFC].

このADRは、ADR 60および61で行われた決定に優先しますが、
この作業の完了した部分に基づいて構築します.以前は、
ピア管理、メッセージ処理、および上位レベルの境界
ビジネスロジック(たとえば、「リアクター」)が混在し、コア
p2pシステムの要素がオーケストレーションを担当します
上位レベルのビジネスロジック.レガシーコンポーネントのリファクタリング
より明白なのは、この責任の絡み合いです
実装全体に大きな影響を与え、
現在の抽象化で繰り返すことは困難です.
レガシーシステムとの相互運用性を維持することは不可能です
このシステムはまた、私たちのより広い目標の多くを達成しました.

LibP2Pは、ピアツーピアの完全に指定された実装です
システム用に設計されたネットワークスタック(次のような)
私たちの. TendermintのベースとしてLibP2Pを採用すると、
テンダーミントチームは、他の差別化により多くの時間を費やします
システムのすべての側面とエコシステムを可能にします
LibP2Pのツールと取り組み全体を使用する
プラットホーム.

## 代替方法

[P2PロードマップRFC] [rfc]で説明されているように、主な代替手段は次のとおりです.
Tendermintのローカルピアツーピアの開発を継続する
床.これにより、テンダーミントチームが最もコントロールできるようになりますが
ピアツーピアシステムと比較して、現在の設計
独自の利点、およびシステムの予想される保守負担
中期的な許容範囲を超えています.

テンダーミントは、に基づいてではなく、それ自体を差別化することができ、またそうすべきです
ネットワーク実装またはピアツーピア管理ツールですが、
一貫した運用経験、実証済みのコンセンサスアルゴリズム、
そして人間工学に基づいたユーザーエクスペリエンス.
## 決定

Tendermintは、0.37の開発サイクルでlibp2pを採用します.
カスタマイズされたTendermintP2Pスタックを交換してください.これにより削除されます
`Endpoint`、` Transport`、 `Connection`、` PeerManager`の抽象化
そして、リアクター、 `p2p.Router`と` p2p.Channel`を離れます
概要.

LibP2Pは、専用のピアツーピア交換(PEX)を必要としない場合があります
リアクター、これはまた、専用の必要性を回避します
シードモード.この場合、これらすべての機能は
取り除かれた.

それが判明した場合(プロトコルラボの推奨に従って)、
別のpubsubまたはgossipsubトピックの意味を維持する
メッセージタイプごとに、 `Router`の抽象化も可能です.
完全に組み込まれました.

## 詳細設計

### 変更を実装する

より高いレベル間のP2P実装の継ぎ目
構造(リアクター)、ルーティングレイヤー( `ルーター`)以下
レベル接続とピア管理コードがこの操作を行います
実装は比較的簡単です.エッセンシャル
この設計の目標は、原子炉への影響を最小限に抑えることです.
(たぶん完全に)そして完全に下位レベルを削除します
コンポーネント(たとえば、 `Transport`、` Connection`、 `PeerManager`)は
`Router`レイヤーによって提供される分離.現在の状態
コードはこれらの変更を比較的外科的に行い、小さなものに限定します
メソッドの数:

-`p2p.Router.OpenChannel`は引き続き `Channel`構造を返します
  それは原子炉と原子炉の間のパイプラインとして機能し続けます
  「ルーター」.実装にはキューが不要になります
  実装しますが、goroutinesを開始します
  チャネルからlibp2pへのメッセージのルーティングを担当します
  基本的な原則は、現在の `p2p.Router.routeChannel`を置き換えることです.

-現在の `p2p.Router.dialPeers`と` p2p.Router.acceptPeers`、
  アウトバウンドおよびインバウンド接続の確立を担当し、
  それぞれ.これらのメソッドは削除され、
  `p2p.Router.openConnection`、libp2p接続マネージャーは
  ネットワーク接続を維持する責任があります.

-`p2p.Channel`インターフェースが変更されてGoに置き換わります
  メッセージを送信するためのより機能的なインターフェイスを備えたチャネル.
  このオブジェクトの新しいメソッドは、コンテキストを使用してセキュリティをサポートします
  キャンセルしてエラーを返し、代わりにブロックする
  非同期で実行します.チャネルを「アウト」し、それを介して
  リアクターはピアにメッセージを送信します.これは「送信」に置き換えられます
  メソッド、およびエラーチャネルは `エラー`に置き換えられます
  方法.

-リアクターは、それらを許可するインターフェースを通過します
  libp2pからピア情報にアクセスします.これは置き換えられます
  `p2p.PeerUpdates`サブスクリプション.

-アプリレベルで何らかのハートビートメッセージを追加する
  (例:リアクターを使用)libp2pに接続できるDHT
  リアクタは、サービスディスカバリ、メッセージの場所、またはその他に使用されます
  特徴.

-既存/従来のハンドシェイクプロトコルを[ノイズ](http://www.noiseprotocol.org/noise.html)に置き換えます.

プロジェクトは最初にTCPベースのトランスポートプロトコルを使用します
libp2p. QUICは、後で実装するオプションとしても使用できます.
初期リリースではハイブリッドネットワークをサポートしませんが、サポートします
本当に必要な場合は、後でこの可能性を再検討してください.

###アップグレードと互換性

ルーターと現在のすべてのP2Pライブラリは「内部」であるため
パッケージはパブリックAPIの一部ではなく、パブリックへの唯一の変更です
TendermintのAPI表面積は異なる構成になります
ファイルオプション、現在のP2Pオプションを関連オプションに置き換えます
libp2pへ.

ただし、2つのネットワークでネットワークを実行することはできません
スタックは一度アクティブ化されるので、Tendermintバージョンにアップグレードしてください
ネットワークのすべてのノード間で調整する必要があります.これは
Tendermintのモバイルアップグレードを取り巻く期待と一致している
前進し、複雑さと
実装スケジュール.

##未解決の問題

-libp2pの実現におけるProtocolLabの役割は何ですか？
  テンダーミントは、最初の実装期間中か継続中かを問わず
  その後の根拠は？

-特定のノードのすべてのP2Pトラフィックを単一のトピックにプッシュする必要があります.
  トピックが特定のChainIDにマップされるように、または
  各リアクター(またはメッセージタイプ)には独自のテーマがありますか？幾つか
  libp2pネットワークはテーマをサポートできますか？検証テストはありますか
  能力？

-Tendermintは現在、非常に大まかなQoSのような機能を提供しています
  メッセージタイプに基づいて優先度を使用します.
  これにより、直感的/理論的に証拠とコンセンサスが保証されます
  ブロック同期/ステータス同期メッセージによってメッセージが枯渇することはありません.それは
  libp2pを使用してコピーできるかどうか、またはコピーする必要があるかどうかは明確ではありません.

-libp2pが提供するQoS機能の種類と種類
  libp2pは、そのQoS機能に関するメトリックを提供しますか？

-追加(おそらく任意)を保存することは可能ですか？
  情報はノード間のハートビートの一部としてDHTに入り、
  たとえば、最新の高さ、そして
  原子炉. DHTはどのくらいの頻度で更新されますか？

-原子炉がエントリを使い果たし続けるようにすることは理にかなっていますか
  チャネルからのメッセージ( `In`)または別のインターフェースがありますか
  どのモデルを検討する必要がありますか？

-Goチャネルをできるだけ公開しないようにする必要があります.
ある種の代替イテレータは処理に意味があるかもしれません
原子炉内のニュース.

-追跡のセキュリティと契約の意味は何ですか
  ピアツーピアのハートビートからの情報とそれを原子炉に公開しますか？

-Tendermintが提供できる構成の量(または量)
  libp2p、特に最初のバージョンでは？

  -一般的に言って、libp2pのbyo-functionityをサポートするべきではありません
Tendermint内のコンポーネントと構成領域の縮小
エリア、可能な限り.

-要求/応答セマンティクスを提供するための最良の方法は何ですか？
  libp2pの上にあるリアクター？追加できますか
  要求/応答のセマンティクスまたは将来のバージョンでの存在
  初期段階の一部として行われると予想される作業
  リリース？

## 結果

### ポジティブ

-以下の方法でTendermintコアチームのメンテナンス負担を軽減します
  であることが証明されている多くのレガシーコードを削除します
  安全に変更することは困難です.

-メンテナンスと開発の全体的な責任を排除します
  ピア管理システム(p2p)とスタック.

-より安定したピアツーピアネットワークシステムをユーザーに提供し、
  Tendermintは、オペレーターのエクスペリエンスとネットワークの安定性を向上させることができます.

### ネガティブ

-ピア管理を実現し、
  ネットワーク、テンダーミントは革新的な柔軟性を失いました
  ピアツーピアおよびネットワークレベル.ただし、テンダーミントは革新的である必要があります
  主にコンセンサスレイヤーで、libp2pは除外しません
  ピアツーピアレベルで最適化または開発します.

-Libp2pは大きな依存関係であり、Tendermintは依存関係になります
  プロトコルラボに基づくリリースサイクルとエラー優先度
  修理.これが面倒であることが判明した場合は、サプライヤーを維持することができます
  必要に応じて、関連するコンポーネントをフォークします.

### ニュートラル

- 適用できない

## 参照する

-[ADR 61:P2P再構成範囲] [adr61]
-[ADR 62:P2Pアーキテクチャ] [adr62]
-[P2PロードマップRFC] [rfc]

[adr61]:./ adr-061-p2p-refactor-scope.md
[adr62]:./ adr-062-p2p-architecture.md
[rfc]:../ rfc/rfc-000-p2p.rst
