# ADR 023:ABCI`ProposeTx`メソッド

## 変更ログ

2018年6月25日:最初のドラフトは[#1776](https://github.com/tendermint/tendermint/issues/1776)に基づいています

## 環境

[#1776](https://github.com/tendermint/tendermint/issues/1776)はい
プラズマサブチェーンの開通を実装するためのテンダーミントの使用について
コアはコンセンサス/レプリケーションエンジンとして機能します。

[Minimal Viable Plasma(MVP)](https://ethresear.ch/t/minimal-viable-plasma/426)および[Plasma Cash](https://ethresear.ch/t/plasma-cash-plasma-)以降with-much-less-per-user-data-checking/1298)、ABCIアプリケーションには、次の状況を処理するメカニズムが必要です(近い将来、さらに多くの状況が発生する可能性があります)。

1.ルートチェーンの `deposit`トランザクションは1つのブロックで構成されている必要があります
     単一のトランザクション、入力なし、1つの出力のみ
     預金者を助長します。 この場合、「ブロック」は次のもので構成されます。
     次の形のトランザクション:
   ```
   [0, 0, 0, 0, #input1 - zeroed out
    0, 0, 0, 0, #input2 - zeroed out
    <depositor_address>, <amount>, #output1 - in favour of depositor
    0, 0, #output2 - zeroed out
    <fee>,
   ]
   ```

「終了」トランザクションも同様の方法で処理できます。
   入力はルートチェーンで終了したUTXOであり、出力はに属します
   予約済みの「書き込み中」アドレス、たとえば「0x0」。この場合、それは役立ちます
   包含ブロックは、可能なトランザクションを1つだけ保存します
   特別扱い。

2.サブチェーン上の他の「内部」トランザクションが開始される場合があります
   一方的。最も基本的な例はコインベーストランザクションです
   バリデーターノードのインセンティブを実装しますが、アプリケーション固有の場合もあります。存在
   これらの場合、それはそのような取引にとって有益かもしれません
   特定の方法で並べ替えられます。たとえば、コインベースのトランザクションは常に
   インデックス0で。一般的に言って、そのような戦略は確実性を高め、
   ブロックチェーンアプリケーションの予測可能性。

使用できますが
現在利用可能な既存のABCIは、次善のソリューションにつながります。 2つは
これについては、以下で詳しく説明します。

### 解決策1:アプリケーションの状態に基づくプラズマチェーン

この作業では、アプリケーションは対応する「PlasmaStore」を維持します
「ゴールキーパー」。 PlasmaStoreは、2番目の独立性を維持する責任があります
`deposit`を含むMVP仕様に準拠したブロックチェーン
ブロックおよびその他の「内部」トランザクション。次に、これらの「仮想」ブロックをブロードキャストします
ルートチェーンへ。

ただし、この素朴なアプローチは、定義上、根本的に欠陥があります。
Tendermintが管理している仕様チェーンとは異なります。これはさらに
このタイプのトランザクションを生成するビジネスロジックが
潜在的な不確実性、これは
`Begin/EndBlock`なので、コンセンサス保証が破られる可能性があります。

さらに、これは「オブザーバー」に依存しないサードパーティに深刻な影響を及ぼします。
記録されたブロックを確保する責任がある補助ブロックチェーンでさえ
ルートチェーンはプラズマチェーンと一致しています。なぜなら、この場合、
プラズマチェーンは、テンダーミントによって維持されている正規チェーンと矛盾しています
根本的に、正当性を検証するためのコンパクトな方法はないようです
作成からのすべての状態遷移を再生する必要のないプラズマチェーン(！)。

### ソリューション2:ABCIアプリケーションからTendermintCoreにブロードキャストする

この方法は、イーサリアムのトランザクションが行われる「テンダーミント」に触発されています
Tendermintコアに転送します。アプリケーションがクライアント接続を維持する必要があります
コンセンサスエンジンへ。

「内部」トランザクションを作成する必要があるときはいつでも、そのトランザクションの提案者
現在のブロックは、トランザクションまたはトランザクションをTendermintに次のようにブロードキャストします。
テンダーミントチェーンとプラズマチェーンが
まったく同じ。

これにより、「内部」トランザクションが完全なコンセンサスを通過できるようになります
処理し、「CheckTx」などの方法で検証できます。
提案者は、意味的に正しいかなどです。これには通知が含まれることに注意してください
ブロック提案者のABCIアプリケーションは、手段として一時的にハッキングされました
この実験を実施しますが、必須ではありません
現在の提案者は「BeginBlock」に渡されます。

これらのトランザクションをルートに直接中継する方がはるかに簡単です
スマートコントラクトをチェーンし、および/または「圧縮された」補助チェーンを維持する
仕様を100％反映したプラズマ対応ブロック(テンダーミント)
ブロックチェーン。残念ながら、この方法は慣用的ではありません(つまり、
予期しない方法でのテンダーミントコンセンサスエンジン)。また、そうではありません
アプリケーション開発者に次のことを許可します。

-提案されたブロック内のトランザクションの_ordering_を制御します(たとえば、インデックス0、
  または、コインベーストランザクションの場合は0から `n`)
-ブロック内のトランザクション数を制御します(たとえば、「デポジット」の場合)
  ブロックが必要です)

ブロックチェーンエンジニアリングでは確実性が非常に重要であるため、この方法では、
より実現可能ですが、本番環境に適していると見なすべきではありません。

## 決定

### `ProposeTx`

上記の問題を解決するために、ABCIインターフェースは
暫定的に「ProposeTx」という名前の追加のメソッドを公開します。

次の署名が必要です。

```
ProposeTx(RequestProposeTx) ResponseProposeTx
```

`RequestProposeTx`と` ResponseProposeTx`は
次の形状:

```
message RequestProposeTx {
  int64 next_block_height = 1; // height of the block the proposed tx would be part of
  Validator proposer = 2; // the proposer details
}

message ResponseProposeTx {
  int64 num_tx = 1; // the number of tx to include in proposed block
  repeated bytes txs = 2; // ordered transaction data to include in block
  bool exclusive = 3; // whether the block should include other transactions (from `mempool`)
}
```

`ProposeTx`は` mempool.Reap`の前に呼び出されます
[OK](https://github.com/tendermint/tendermint/blob/9cd9f3338bc80a12590631632c23c8dbe3ff5c34/consensus/state.go#L935)。
`exclusive`が` true`であるか `false`であるかに応じて、それが推奨されます
次に、トランザクションをスレーブにプッシュします
`mempool.Reap`。

### `DeliverTx`

`ProposeTx`から受信した` tx`のリストは `CheckTx`を通過しないので、
「内部」トランザクションを区別する方法を提供することは良い考えかもしれません
ユーザー生成から、アプリケーション開発者が追加の対策を講じる必要がある/したい場合
提案されたトランザクションの有効性を確認します。

したがって、「RequestDeliverTx」メッセージを変更して、次のように追加のフラグを提供する必要があります。

```
message RequestDeliverTx {
	bytes tx = 1;
	bool internal = 2;
}
```

または、コンパニオンとしてメソッド「DeliverProposeTx」を追加できます
`ProposeTx`。ただし、追加費用が必要かどうかは明確ではありません
今では、コンセンサスの保証を維持するには、単純なロゴで十分かもしれません。

## ステータス

する

## 結果

### ポジティブ

-Tendermint ABCIアプリケーションは、最小限の実行可能なプラズマチェーンとして動作できるようになります。
-`cosmos-sdk`に拡張機能を追加して有効にすることができます
  ABCIアプリケーションは、相互運用性を最大化するためにIBCとPlasmaをサポートします。
-ABCIアプリケーションは、ブロックチェーンの状態を管理する上で優れた制御と柔軟性を備えています。
  非決定論的なハッカーや安全でないソリューションに頼る必要はありません

### ネガティブ

-追加のABCIメソッドのメンテナンスオーバーヘッドを公開します
-見落とされていた可能性があるが、今は広範囲にテストする必要がある潜在的なセキュリティ問題

### ニュートラル

-ABCI開発者は、(名目ではありますが)増加したAPI表面積に対処する必要があります。

## 参照する

-[#1776プラズマおよびABCIアプリケーションの「内部」トランザクション](https://github.com/tendermint/tendermint/issues/1776)
-[Minimal Living Plasma](https://ethresear.ch/t/minimal-viable-plasma/426)
-[Plasma Cash:Plasmaのユーザーあたりのデータチェックははるかに少ない](https://ethresear.ch/t/plasma-cash-plasma-with-much-less-per-user-data-checking/1298)
