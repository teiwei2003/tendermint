# RFC 006:イベントサブスクリプション

## 変更ログ

-2021年10月30日:最初のドラフト(@creachadair)

## 概要

Tendermintコンセンサスノードにより、クライアントはそのイベントストリームにサブスクライブできます
RPCサービスのメソッドを介して.イベントストリームを表示する機能は次のとおりです.
顧客にとって価値がありますが、現在の実装にはいくつかの欠点があります
一部のお客様がそれを効果的に使用することを困難にします. RFCはこれらを文書化します
問題を解決し、これらの問題に対する可能な解決策について話し合います.


## バックグラウンド

実行中のTendermintコンセンサスノードのエクスポート[JSON-RPCサービス] [rpc-service]
チェックとチェックのための[多数のメソッド] [rpc-methods]を提供します
ノードと対話します.これらのメソッドの重要なクラスターは
`subscribe`、` unsubscribe`、および `unsubscribe_all`メソッド、クライアントを許可する
[ノード生成イベント] [イベント]のフィルタリングされたストリームをサブスクライブします
実行時.

他のサービス方法とは異なり、「イベント」の方法
「サブスクリプション」クラスターは[通常のHTTPGETまたはPOSTを渡すことができません
リクエスト] [rpc-transport]、ただしHTTP接続をにアップグレードする必要があります
[ネットワークソケット] [ws]. `subscribe`リクエストには1つ必要なので、これが必要です
結果をクライアントの永続チャネルとプレーンHTTPに返します
接続は、複数の要求にわたって確実に持続することはできません.これらのために
永続的なチャネルがない場合、メソッドは正しく機能しません.メソッドは_only_です.
WebSocket接続を介してエクスポートします.これは、純粋なHTTPルートではありません.


## 議論する

現在のイベントの実装にはいくつかの運用上の問題があります
RPCサービスのサブスクリプション:

-**イベント配信は有効なJSON-RPCではありません. **クライアントが `subscribe`を送信するとき
  リクエスト、サーバーは最初の空の確認で応答します(正しい)
  ( `{}`).その後、すべての一致するイベントが「積極的に提供」されます(
  別の[応答オブジェクト] [json-response]としてのクライアントからの別のリクエスト)
  最初のリクエストと同じIDを持っています.

  これは、標準のJSON-RPCクライアントライブラリではできないことを意味するため、重要です.
  イベントサブスクリプションメカニズムと正しく対話します.

  サーバーによってプッシュされた一方的な値を処理できるクライアントの場合でも、
  これらの応答は無効です.IDを持っているため、考慮できません.
  [通知] [json-notify];ただし、IDはリクエストに対応しています
  完成しました.実際には、これは一般的なJSON-RPCを意味します
  ライブラリはこのメソッドを正しく使用できません.カスタムクライアントが必要です.

  TendermintのコアGoRPCクライアントはこの状況をサポートできますが、クライアントは
  他の言語には簡単な解決策はありません.

  これが問題の原因です[#2949] [issue2949].

-**切断によりサブスクリプションが終了しました. **に接続されている場合
  クライアントが中断され、サブスクリプションが静かに削除されました.

  これは合理的な動作ですが、お客様が重要であるため重要です
  サブスクリプションは、有用なエラーフィードバックを取得せずに削除されました.シャットダウンするだけです.
  接続.彼らは再試行する必要がありますか？ノードが過負荷になっていますか？顧客です
  遅すぎる？発信者はpingに応答するのを忘れましたか？これらのタイプをデバッグする
  失敗は不必要な苦痛です.

  WebSocketはこれを複雑にします.そうでない場合、WebSocket接続がタイムアウトになるためです.
  あなたは一定期間トラフィックを見ることができます、そしてあなたはそれらを生き続けるために積極的である必要があります
  クライアントとサーバー間の連携.通常のTCPソケット、ライブネスを使用する
  キープアライブメカニズムによって透過的に処理されます.ネットワークソケットでは、
  ただし、一方の側がPINGを送信する必要がある場合があります(接続が
  それ以外の場合はアイドル).相手は、一致するPONGを時間内に返送する必要があります.
  切断します.退屈であることに加えて、これは簡単に影響を受けます
  CPU負荷に.

  Tendermint Goの実装は、pingを自動的に送信して応答します.
  他の言語のクライアント(またはTendermintライブラリを使用したくない)
  明示的に処理する必要があります.これは顧客に非現実的な負担をかけます
  利点:加入者は、マッチングイベントがいつ発生する可能性があるかについての情報を持っていません
  利用可能であるため、接続の維持に関与しないでください
  住む.

-**負荷プロファイルの不一致. **ほとんどのRPCサービスは主に
  少量のローカル使用、またはノードによって提供されるアプリケーション(例:
  ABCIメソッド)またはノード演算子(たとえば、情報メソッド).イベント
  サブスクリプションはリモートクライアントにとって重要であり、より高いレベルを表す場合があります
  フロー.

どちらも同じJSON-RPCメカニズムを使用するため、これは重要です.にとって
  少量のローカル使用、JSON-RPCの人間工学は非常に適しています:それは簡単です
  コマンドラインから(たとえば、 `curl`を使用して)クエリを発行するか、スクリプトを記述します
  RPCメソッドを呼び出して、実行中のノードを監視します.

  多数のリモート使用には、JSON-RPCは適していません.
  上記の非標準の配信プロトコルに加えて、時間とメモリ
  イベントデータをエンコードするコストは、ノードの安定性にとって非常に重要です.
  数百人の加入者がいる可能性があります.さらに、サブスクリプションは
  ほとんどのRPCメソッドと比較して、存在し続けることができるため、長寿命です.
  ノードはアクティブです.

-**比類のないセキュリティプロファイル. ** RPCサービスはいくつかのメソッドをエクスポートします
  正確かどうかにかかわらず、リモートの発信者には公開しないでください
  理由(たとえば、 `remove_tx`と` broadcast_tx_ * `)と操作
  安定性の理由(たとえば、 `tx_search`).ノードはまだ公開する必要があるかもしれません
  ただし、UIツールをサポートするためのイベント.

  すべてのメソッドが同じネットワークエンドポイントを共有するため、これは重要です.でも
  プロキシを使用して、トップレベルのGETおよびPOSTハンドラーをブロックできます.
  `/websocket`ハンドラーを公開すると、_only_イベントサブスクリプションが公開されます
  方法ですが、残りのサービスもそうです.

### 可能な改善

開発者エクスペリエンスを向上させるためにできることがいくつかあります
コンセンサスノードからのイベントをサブスクライブする必要があるのは誰か.これらはすべてではありません
相互に排他的.

1.**イベントサブスクリプションを個別のサービスに分割します**.公開する代わりに
   残りのRPCサービスと同じエンドポイントでのイベントサブスクリプション、
   ノードには、_only_イベントサブスクリプション専用の個別のエンドポイントがあります.この
   残りのRPCサービス(_sans_イベント)はそのまま残ります.

   ファイアウォールの外側で機密性の高いものを無効にしたりアクセスしたりするのは簡単です
   RPCメソッドは、イベントサブスクリプションへのアクセスを妨げません(その逆も同様です).
   他に何もしなくても、やる価値があるかもしれません
   ここで説明してください.

2.**イベントサブスクリプションには異なるプロトコルを使用します. **多くの方法があります
   私たちはこの問題を解決することができます、それは私たちがどれだけ変えても構わないと思っているかに依存します
   現在のAPI.これがいくつかのオプションのスケッチです:

   -WebSocketを維持しますが、JSON-RPCに準拠するようにAPIを再設計します.
     たぶん、イベントの配信を通知に変えることによって.これは少ないです
     既存のお客様の以前の変更、ただしすべての既存の変更
     実装の複雑さ、およびより深刻なものへの貢献はほとんどありません
     パフォーマンスとユーザーエクスペリエンスの改善は後で行われます.

   -WebSocketから通常のHTTPに切り替え、サブスクリプションAPIを次のように再設計します
     ストリーミングの代わりに、より伝統的な要求/応答モデルを使用します.
     既存のお客様の場合、これはより予備的な作業ですが、
     Goで記述されていないクライアントにより良いライブラリサポートを提供します.

     合意はもっとおしゃべりになりますが、私たちは合格することができます
     バッチ処理の見返りとして、何をすべきかをより適切に制御できます
     遅いクライアント:今のように黙ってクライアントを放棄するのではなく、
     メッセージを破棄し、一部のデータが欠落していることをクライアントに通知する場合があります( "M
     前回のポーリング以降に破棄されたメッセージ」).

     このオプションは、作業、APIの変更、および
     利点、および優れた副作用があり、デバッグが容易になります
     他のRPCメソッドと同様に、コマンドラインからサブスクライブします.

-gRPCに切り替えます:持続的接続を維持し、より多くを提供します
     を犠牲にして効率的なバイナリワイヤフォーマット(protobuf)
     クライアントであり、デバッグがより困難です.パフォーマンスが良ければ、これが最良の選択かもしれません
     そして、サーバーの負荷が私たちの最大の関心事です.

     ただし、現在JSON-RPCを使用していることを考えると、私は信じていません
     イベントサブスクリプションチャネルでのメッセージのエンコードと送信のコスト
     ただし、これはサブスクリプション効率の制限要因です.

3.**イベントサブスクリプションをエージェントに委任します. ** 責任者
   ノードとは別に実行されているエージェントのイベントサブスクリプションを管理します.
   そして、ノードを切り替えて、イベントを代わりにエージェント(webhookなど)にプッシュします
   加入者に直接サービスを提供します.これはオペレーターにとってより多くの作業です(別の
   構成と運用プロセス)が、大規模なネットワークをより適切に拡張できます.

   完全を期すために、このオプションについて説明しましたが、この変更を行うと、
   かなりのプロジェクトです.責任の移転を検討する場合
   いずれにせよ、ノード外のイベントサブスクリプションの場合、おそらくもっと多くのイベントが必要です
   体系的に紹介します.より原理的なアプローチについては、以下のポイント(4)を参照してください.

4.**イベントサブスクリプションをインデックスのダウンストリームに移動します. **私たちはすでに計画しています
   アプリケーションがイベントインデックスをより適切に制御できるようにします.ひいては、
   アプリケーションがイベントのフィルタリング方法も制御できるようにする場合があります.
   クエリとサブスクライブ.アプリケーションにこれらの問題を制御させます.
   ノードの代わりに、開発者がUIを構築しやすくする可能性があります.
   アプリケーションのツール.

   これは大きな変化なので、あまり実用的ではないと思います
   短期的には、より幅広い選択肢として検討する価値があります.いくつかの
   既存のフィルタリングおよび選択コードをより再利用可能にすることができます.
   したがって、アプリケーションはすべてを再発明する必要はありません.


## 参照する

-[TendermintRPCサービス] [rpc-service]
-[TendermintRPCルーティング] [rpc-methods]
-[イベントシステムディスカッション] [イベント]
-[RPC送信オプションに関する議論] [rpc-transport](RFC 002から)
-[RFC 6455:websocketプロトコル] [ws]
-[JSON-RPC 2.0仕様](https://www.jsonrpc.org/specification)

[rpc-service]:https://docs.tendermint.com/master/rpc/
[rpc-method]:https://github.com/tendermint/tendermint/blob/master/internal/rpc/core/routes.go#L12
[イベント]:./rfc-005-event-system.rst
[rpc-transport]:./rfc-002-ipc-ecosystem.md#rpc-transport
[ws]:https://datatracker.ietf.org/doc/html/rfc6455
[json-response]:https://www.jsonrpc.org/specification#response_object
[json-notify]:https://www.jsonrpc.org/specification#notification
[issue2949]:https://github.com/tendermint/tendermint/issues/2949
